
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Dashboard</title>
<link rel="stylesheet" href="/profile.css">
</head>
<body>

<%
  // 1. Get existing avatar from variables passed by the server
  const rawAvatar = (typeof avatarUrl !== "undefined" && avatarUrl) 
                    ? avatarUrl 
                    : (user && user.avatarUrl ? user.avatarUrl : null);

  // 2. Generate Default Avatar (Initials)
  const safeName = user && user.name ? user.name : "User";
  const initials = safeName.charAt(0).toUpperCase();
  const defaultAvatar = "https://ui-avatars.com/api/?name=" + 
    encodeURIComponent(initials) + 
    "&size=200&background=00d4ff&color=0f2027&bold=true";

  // 3. Determine Final Source
  let avatarSrc = defaultAvatar; // Start with default

  if (rawAvatar) {
      // FIX: Replace Windows backslashes (\) with forward slashes (/)
      let cleanPath = rawAvatar.replace(/\\/g, "/");

      // FIX: Check if it is an external link (http) OR already has a slash
      if (cleanPath.startsWith("http") || cleanPath.startsWith("data:")) {
          avatarSrc = cleanPath;
      } else {
          // If it doesn't start with /, add it.
          avatarSrc = cleanPath.startsWith("/") ? cleanPath : "/" + cleanPath;
      }
  }

  // Style for remove button
  const removeStyle = (avatarSrc !== defaultAvatar) ? "display:inline-block;" : "display:none;";
%>
<%

  console.log("AVATAR URL:", user && user.avatarUrl);
%>

  <%- include('../partials/header') %>

  <div class="floating-orbs">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>

  <div class="container">
    <div class="dashboard-header">
      <h1>Profile Dashboard</h1>
      <p>Welcome back! Here's your profile overview</p>
    </div>

    <div class="profile-grid">
      <!-- Left Column: Profile Card -->
      <div class="profile-card">
        <div class="profile-photo-container">
          <div class="profile-photo-wrapper">
            <div class="photo-rings">
              <div class="photo-ring"></div>
              <div class="photo-ring"></div>
            </div>

<img
 id="avatarPreview"
  class="profile-photo "
  src="<%= avatarSrc %>"
  alt="Profile Image"
  class="avatar-preview"
 
/>

          </div>
        </div>

        <!-- <h2 class="profile-name"><%= initials %></h2> -->
        <p class="profile-role">Senior Full Stack Developer</p>

        <div class="profile-stats">
          <div class="stat-item">
            <span class="stat-number">48</span>
            <span class="stat-label">Projects</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">1.2K</span>
            <span class="stat-label">Followers</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">352</span>
            <span class="stat-label">Following</span>
          </div>
        </div>
      </div>

      <!-- Right Column: Information Card -->
      <div class="info-card">
        <div style="justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <% if (user && user.hashPassword) { %>
            <a href="/change-password" class="edit-btn">
              <svg viewBox="0 0 24 24" width="18" height="18">
                <path fill="currentColor"
                  d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
              </svg>
              Change Password
            </a>
          <% } else { %>
            <a href="/set-password" class="edit-btn">
              <svg viewBox="0 0 24 24" width="18" height="18">
                <path fill="currentColor"
                  d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
              </svg>
              Set Password
            </a>
          <% } %>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h2 style="margin-bottom: 0;">Personal Information</h2>
          <button id="editBtn" class="edit-btn" type="button">
            <svg viewBox="0 0 24 24" width="18" height="18">
              <path fill="currentColor"
                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
            </svg>
            Edit Profile
          </button>
        </div>

        <!-- Form for edit/update -->
      <form id="profileForm" method="POST" action="/profile" enctype="multipart/form-data">
         <input type="file" id="imageInput" name="avatar" accept="image/*" style="display:none;">

         <div class="image-upload-section edit-mode-only" style="display:none;">

            <div class="upload-controls">
              <!-- Hidden file input -->
         <input type="file" id="imageInput" name="avatar" accept="image/*" style="display:none;">

              <!-- Upload Button -->
              <button type="button" class="upload-btn" id="uploadBtn">
                <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                Upload Photo
              </button>

              <!-- Remove Button (style precomputed to avoid EJS quoting issues) -->
              <button type="button" class="remove-btn" id="removeBtn" style="<%= removeStyle %>">
                <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                Remove
              </button>
            </div>

            <p class="upload-hint">JPG, PNG or GIF (Max 5MB)</p>
          </div>

          <!-- Hidden flag - tells server to remove existing avatar if user clicked Remove -->
          <input type="hidden" name="removeAvatar" id="removeAvatar" value="false">

          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Full Name</div>
              <div class="info-value view-mode"><%= user && user.name ? user.name : '' %></div>
              <input type="text" name="name" value="<%= user && user.name ? user.name : '' %>" class="info-input edit-mode" style="display: none;">
            </div>

            <div class="info-item">
              <div class="info-label">Email Address</div>
              <div class="info-value view-mode"><%= user && user.email ? user.email : '' %></div>
              <input type="email" name="email" value="<%= user && user.email ? user.email : '' %>" class="info-input edit-mode" style="display: none;" readonly>
            </div>

            <div class="info-item">
              <div class="info-label">Phone Number</div>
              <div class="info-value view-mode">+1 (555) 123-4567</div>
              <input type="tel" name="phone" value="+1 (555) 123-4567" class="info-input edit-mode" style="display: none;">
            </div>

            <div class="info-item">
              <div class="info-label">Member Since</div>
              <div class="info-value">
                <%= user && user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '' %>
              </div>
            </div>

            <div class="info-item">
              <div class="info-label">Department</div>
              <div class="info-value view-mode">Engineering</div>
              <input type="text" name="department" value="Engineering" class="info-input edit-mode" style="display: none;">
            </div>

            <div class="info-item">
              <div class="info-label">Status</div>
              <div class="status-active">
                <div class="tick-circle">
                  <div class="blink-dot-container">
                    <div class="blink-dot"></div>
                  </div>
                  <span>Active</span>
                </div>
              </div>
            </div>
          </div>

          <div class="edit-actions" style="display: none; margin-top: 2rem; gap: 1rem;">
            <button type="submit" class="save-btn">
              <svg viewBox="0 0 24 24" width="18" height="18">
                <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
              </svg>
              Save Changes
            </button>
            <button type="button" id="cancelBtn" class="cancel-btn">Cancel</button>
          </div>
        </form>

        <div class="email-verification-item">
          <p class="info-label">Email Verification</p>
          <div class="verification-status">
            <% if (user && user.isEmailValid) { %>
              <div class="verified-badge">
                <svg class="check-icon" viewBox="0 0 52 52">
                  <circle class="check-circle" cx="26" cy="26" r="25" fill="none"/>
                  <path class="check-path" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <span>Email Verified</span>
              </div>
            <% } else { %>
              <div class="unverified-badge">
                <svg class="alert-icon" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <span>Email Not Verified</span>
              </div>
              <a href="/verify-email" class="verify-link">
                <span style="color: white;">Verify Now</span>
                <svg class="arrow-icon" viewBox="0 0 24 24">
                  <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                </svg>
              </a>
            <% } %>
          </div>
        </div>
      </div> <!-- end .info-card -->
    </div> <!-- end .profile-grid -->

    <!-- Activity Section -->
    <div class="activity-section">
      <h2>Recent Activity</h2>
      <div class="activity-timeline">
        <div class="activity-item">
          <div class="activity-title">Updated profile photo</div>
          <div class="activity-time">2 hours ago</div>
        </div>
        <div class="activity-item">
          <div class="activity-title">Completed project "E-commerce Platform"</div>
          <div class="activity-time">1 day ago</div>
        </div>
        <div class="activity-item">
          <div class="activity-title">Joined the Development Team</div>
          <div class="activity-time">3 days ago</div>
        </div>
      </div>
    </div>

  </div> <!-- end .container -->
</body>
<script>
  const editBtn = document.getElementById("editBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const removeBtn = document.getElementById("removeBtn");
  const imageInput = document.getElementById("imageInput");
  const avatarPreview = document.getElementById("avatarPreview");
  const removeAvatarInput = document.getElementById("removeAvatar");

  const defaultAvatar = "https://ui-avatars.com/api/?name=<%= initials %>&size=200&background=00d4ff&color=0f2027&bold=true";
  const currentAvatar = "<%= avatarSrc %>";

  // Toggle Edit Mode
  editBtn.addEventListener("click", () => {
    document.querySelectorAll(".view-mode").forEach(el => el.style.display = "none");
    document.querySelectorAll(".edit-mode, .edit-mode-only").forEach(el => el.style.display = "block");
    document.querySelector(".edit-actions").style.display = "flex";
    editBtn.style.display = "none";
  });

  // Cancel Edit
  cancelBtn.addEventListener("click", () => {
    document.querySelectorAll(".view-mode").forEach(el => el.style.display = "block");
    document.querySelectorAll(".edit-mode, .edit-mode-only").forEach(el => el.style.display = "none");
    document.querySelector(".edit-actions").style.display = "none";
    editBtn.style.display = "inline-flex";
    
    // Reset image
    avatarPreview.src = currentAvatar;
    imageInput.value = "";
    removeAvatarInput.value = "false";
  });

  // Upload Button
  uploadBtn.addEventListener("click", () => imageInput.click());

  // Preview Upload
  imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        avatarPreview.src = event.target.result;
        removeBtn.style.display = "inline-block";
        removeAvatarInput.value = "false";
      };
      reader.readAsDataURL(file);
    }
  });

  // Remove Image
  removeBtn.addEventListener("click", () => {
    avatarPreview.src = defaultAvatar;
    imageInput.value = "";
    removeAvatarInput.value = "true";
    removeBtn.style.display = "none";
  });
</script>

</body>
</html>
